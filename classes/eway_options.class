<?php
///////////////////////////////////////////////////////////////////////////////
//
// eway_options.class - Class for storing temporary data used in payments
// $Id$
//
///////////////////////////////////////////////////////////////////////////////
//
// HISTORY:
// $Log$
///////////////////////////////////////////////////////////////////////////////
include_once "db.class";
include_once "config.class";
include_once "audit.class";

class eway_options {

  var $customer_id;
  var $api_key;
  var $api_password;
  var $ddlSandbox;
  var $ddlMethod;
  var $timestamp;
  
  var $db;
  var $server_name;
  var $database_name;
  var $user_name;
  var $user_password;


  /* function user() 
  **
  ** DESCRIPTION: Class constructor, initalizes and sets up DB connectoin
  **
  ** PARAMETERS:
  **
  ** RETURNS:
  ** 
  */
  function eway_options() { 
    
	
    $config = new config();
    
    $this->server_name = $config->mysql_server_name;
    $this->database_name = $config->mysql_database_name;
    $this->user_name = $config->mysql_user_name;
    $this->user_password = $config->mysql_user_password;

    $this->db = new db($this->server_name, $this->database_name, $this->user_name, $this->user_password);

  }

  /* function load()
  **
  ** DESCRIPTION: loads data from table
  **
  ** PARAMETERS:
  ** - none
  **
  ** RETURNS:
  ** 1 - sucess
  ** 0 - fail
  ** 
  */
  function load() {
      
      $query = "SELECT * FROM eway_options WHERE wholesaler_id = " . $this->db->quote($this->wholesaler_id) . " ORDER BY timestamp DESC LIMIT 1";
      $result = $this->db->execute_query($query);
      
      if ($result != 0 ) {

        $row = $this->db->fetch_row_array($result);
        
        if(is_array($row)){
          while ($cel = each($row)) {

  	        $key = $cel['key'];
            
            $this->{$key} = $cel['value'];
            
          }
        }
      }

    return 0;
    
  }

  /* function exist()
  **
  ** DESCRIPTION: checks to see if an id exists
  **
  ** PARAMETERS:
  ** - none
  **
  ** RETURNS:
  ** 1 - user exists
  ** 0 - user does not exist
  ** 
  */
  function exist() {
  
    $this->api_key = $this->api_key;
  
    // Check we have an user
    if (!$this->api_key) {
    
      return 0;
      
    }
    
    $query = "SELECT * FROM eway_options WHERE api_key = " . $this->db->quote($this->api_key);
    $result = $this->db->execute_query($query);
      
    if ($result != 0 ) {
    
      $row_count = $this->db->fetch_row_count($result);
      
      if ($row_count == 1) {
      
        return 1;
        
      } else {
      
        return 0;
        
      }
      
    }
    
    return 0;
  
    
  }

  /* function create()
  **
  ** DESCRIPTION: creates a new entry
  **
  ** PARAMETERS:
  ** - none
  **
  ** RETURNS:
  ** 1 - sucess
  ** 0 - fail
  ** 
  */
  function create_real() {
    

    // Create the account
    $query = "INSERT INTO eway_options ( wholesaler_id, api_key, api_password, ddlSandbox, ddlMethod)";
    $query .= " VALUES (" . $this->db->quote($this->wholesaler_id) . "," . $this->db->quote($this->api_key) . "," . $this->db->quote($this->api_password) . "," . $this->db->quote($this->ddlSandbox) . "," . $this->db->quote($this->ddlMethod) . ")";

    $result = $this->db->execute_query($query);
    

    if ($result == 0) {
      return 0;
      
    } else {

      //Audit section for storing first changes
      $temp = get_object_vars($this);

      unset($temp['db']);
      unset($temp["server_name"]);
      unset($temp["database_name"]);
      unset($temp["user_name"]);
      unset($temp["user_password"]);
      $keys = array_keys($temp);

      $changes = new audit();
      $changes->store_first_changes($keys,$this,"eway_options",$this->wholesaler_id);

      return 1;
					
    }
  }
  
  function create() {
  
    if ($this->create_real() == 1) {

      $this->load();
    
      return 1;
      
    } else {
    
      return 0;
      
    }    
      
  }

  /* function save_real()
  **
  ** DESCRIPTION: saves current data into an already existant entry
  **
  ** PARAMETERS:
  ** - none
  **
  ** RETURNS:
  ** 1 - sucess
  ** 0 - fail
  ** 
  */
  function save_real() {

    // Check if id exists    
    if (!eway_options::exist()) {
      return 0;
      
    }

    $eway_options = new eway_options();
    $eway_options->wholesaler_id = $this->wholesaler_id;
    $eway_options->api_key = $this->api_key;
    $eway_options->get_id_key();
    
    $query = "UPDATE eway_options SET api_password = " . $this->db->quote($this->api_password);
    $query .= ", ddlSandbox = " . $this->db->quote($this->ddlSandbox);
    $query .= ", ddlMethod = " . $this->db->quote($this->ddlMethod);
    $query .= " WHERE wholesaler_id = " . $this->db->quote($this->wholesaler_id);
    $query .= " AND api_key = " . $this->db->quote($this->api_key);

    $result = $this->db->execute_query($query);

    if ($result == 0) {

      return 0;
      
    } else {

      //Audit section for storing first changes
      $temp = get_object_vars($this);

      unset($temp['db']);
      unset($temp["server_name"]);
      unset($temp["database_name"]);
      unset($temp["user_name"]);
      unset($temp["user_password"]);
      unset($temp["timestamp"]);
      $keys = array_keys($temp);
      
      $changes = new audit();
      $changes->store_changes($keys,$eway_options,$this,"eway_options",$this->wholesaler_id);

      return 1;
        
    }
  }

  function save() {
  
    if ($this->save_real() == 1) {

      $this->load();
    
      return 1;
      
    } else {
    
      return 0;
      
    }    
      
  }

  /* function get_id_key()
  **
  ** DESCRIPTION: loads data from table
  **
  ** PARAMETERS:
  ** - none
  **
  ** RETURNS:
  ** 1 - sucess
  ** 0 - fail
  ** 
  */
  function get_id_key() {
      
      $query = "SELECT * FROM eway_options WHERE wholesaler_id = " . $this->db->quote($this->wholesaler_id) . " AND api_key = " . $this->db->quote($this->api_key);
      $result = $this->db->execute_query($query);
      
      if ($result != 0 ) {

        $row = $this->db->fetch_row_array($result);
        
        if(is_array($row)){
          while ($cel = each($row)) {

            $key = $cel['key'];
            
            $this->{$key} = $cel['value'];
            
          }
        }
      }

    return 0;
    
  }

}

